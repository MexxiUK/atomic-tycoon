<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atomic Tycoon v1.1.3 - System Integrity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            background-color: #05070a;
            color: #d1d5db;
            font-family: 'JetBrains+Mono', monospace;
            user-select: none;
            overflow-x: hidden;
        }

        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 50;
        }

        .heat-bar-bg {
            background: #111827;
            border: 1px solid #374151;
            position: relative;
            overflow: hidden;
            height: 18px;
            display: flex;
        }

        .heat-zone-marker {
            position: absolute;
            top: 0; bottom: 0;
            width: 1px;
            background: rgba(255,255,255,0.2);
            z-index: 10;
        }

        .heat-bar-fill { height: 100%; transition: width 0.05s linear; position: relative; z-index: 5; }

        .zone-tier-1 { background: #22c55e; }
        .zone-tier-2 { background: #84cc16; }
        .zone-tier-3 { background: #eab308; }
        .zone-tier-4 { background: #ef4444; animation: redline-flicker 0.1s infinite; }

        @keyframes redline-flicker {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .building-card {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid #374151;
            transition: all 0.2s;
        }
        .building-card:hover:not(.disabled-milestone) { border-color: #10b981; background: rgba(31, 41, 55, 0.8); }
        .disabled-milestone { opacity: 0.4; cursor: not-allowed; grayscale: 100%; }
        .not-affordable { opacity: 0.5; }

        .scram-active { border-color: #ef4444 !important; animation: border-flicker 0.2s infinite; }
        @keyframes border-flicker {
            0% { border-color: #ef4444; box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.2); }
            100% { border-color: #450a0a; box-shadow: inset 0 0 20px rgba(239, 68, 68, 0.4); }
        }

        .city-grid-item { width: 10px; height: 10px; border-radius: 1px; transition: all 0.4s ease; }
        .city-grid-dim { opacity: 0.1 !important; box-shadow: none !important; }
        .brownout-flicker { animation: flicker 0.5s infinite; }

        .shake-light { animation: shake 0.5s infinite; }
        .shake-heavy { animation: shake 0.2s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        select.manager-select {
            background-color: #111827;
            border: 1px solid #4b5563;
            color: #d1d5db;
            font-size: 9px;
            padding: 2px;
            border-radius: 2px;
            width: 100%;
            cursor: pointer;
            outline: none;
            text-transform: uppercase;
            font-weight: bold;
        }

        .master-ovr-btn {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            touch-action: none;
        }
        .master-ovr-active {
            background-color: #7f1d1d !important;
            border-color: #ef4444 !important;
            color: #fee2e2 !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            transform: scale(0.98);
            text-shadow: 0 0 5px #fff;
        }

        .icon-container {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #0f172a;
            color: #fff;
            text-align: center;
            border: 1px solid #3b82f6;
            padding: 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            line-height: 1.5;
            pointer-events: none;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.7);
            text-transform: none;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .reactor-card-fixed { height: 250px; }

        .upgrade-tray-item {
            background: rgba(22, 28, 41, 0.8);
            border: 1px solid #4b5563;
            padding: 12px;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
            position: relative;
            overflow: hidden;
        }
        .upgrade-tray-item.affordable {
            border-color: #34d399;
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
        }
        .upgrade-tray-item.affordable:hover {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            transform: translateY(-2px);
        }
        .upgrade-tray-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #374151;
        }
        .upgrade-tray-item.installed {
            border-color: #3b82f6;
            background: rgba(30, 58, 138, 0.3);
            cursor: default;
            opacity: 0.9;
        }
        .installed-badge {
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 7px;
            color: #60a5fa;
            background: rgba(30, 58, 138, 0.5);
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: bold;
            text-transform: uppercase;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }
        .upgrade-cost-text { font-size: 12px; font-weight: 700; margin-top: 6px; }
        .upgrade-title-text { font-size: 12px; font-weight: 800; letter-spacing: -0.01em; }
        .upgrade-desc-text { font-size: 10px; line-height: 1.3; margin-top: 4px; }

        #debug-panel {
            background: rgba(17, 24, 39, 0.98);
            border-top: 2px solid #ef4444;
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 1rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 pb-16">
    <div class="crt-overlay"></div>

    <div class="max-w-6xl mx-auto">
        <!-- HEADER STATS -->
        <header class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 bg-gray-900/80 p-6 rounded-lg border border-gray-700">
            <div class="text-center md:text-left">
                <p class="text-[9px] uppercase text-gray-500 tracking-widest">Capital Reserve</p>
                <h2 class="text-3xl font-bold text-emerald-400">$<span id="cash-display">0</span></h2>
            </div>
            <div class="text-center">
                <p class="text-[9px] uppercase text-gray-500 tracking-widest">Net Revenue</p>
                <h2 class="text-2xl font-bold text-blue-400">$<span id="income-display">0</span><span class="text-sm">/s</span></h2>
                <div id="efficiency-tag" class="text-[8px] font-bold text-emerald-500 bg-emerald-950/30 px-2 py-0.5 rounded-full inline-block mt-1 uppercase tracking-widest">Efficiency: 100%</div>
            </div>
            <div class="text-center">
                <p class="text-[9px] uppercase text-gray-500 tracking-widest">Export Market</p>
                <h2 class="text-2xl font-bold text-orange-400">$<span id="export-display">0</span><span class="text-sm">/s</span></h2>
                <div class="text-[8px] text-gray-500 uppercase tracking-tighter">Selling Surplus MW</div>
            </div>
            <div class="text-center md:text-right">
                <p class="text-[9px] uppercase text-gray-500 tracking-widest">Global Grid Load</p>
                <h2 class="text-2xl font-bold"><span id="power-used">0</span> / <span id="power-total">0</span> <span class="text-sm text-gray-500">MW</span></h2>
                <div id="stability-indicator" class="text-[10px] uppercase text-emerald-500 font-bold tracking-widest">System Stable</div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- LEFT COLUMN -->
            <div class="lg:col-span-4 space-y-6">
                <h3 class="text-lg font-bold border-b border-gray-700 pb-2 flex items-center uppercase tracking-tighter">
                    <span class="mr-2">üèôÔ∏è</span> City Expansion
                </h3>

                <div id="build-list" class="space-y-3">
                    <div id="btn-house" onclick="buyBuilding('house')" class="building-card p-3 rounded-md cursor-pointer flex items-center gap-4 transition-all">
                        <div class="icon-container text-emerald-500"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-emerald-400 text-[11px] uppercase">Housing</h4>
                                <span class="text-[11px] font-bold">$<span id="cost-house">100</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500">1 MW | $2/s ‚Ä¢ <span id="count-house">0</span> Units</p>
                        </div>
                    </div>

                    <div id="btn-factory" onclick="buyBuilding('factory')" class="building-card p-3 rounded-md cursor-pointer disabled-milestone flex items-center gap-4 transition-all">
                        <div class="icon-container text-blue-500"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20V4l7 5V4l7 5V4l6 4v12H2Z"></path></svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-blue-400 text-[11px] uppercase tracking-tighter">Industrial</h4>
                                <span class="text-[11px] font-bold">$<span id="cost-factory">25k</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500" id="factory-desc">25 MW | $150/s ‚Ä¢ <span id="count-factory">0</span> Units</p>
                        </div>
                    </div>

                    <div id="btn-datacenter" onclick="buyBuilding('datacenter')" class="building-card p-3 rounded-md cursor-pointer disabled-milestone flex items-center gap-4 transition-all">
                        <div class="icon-container text-purple-500"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><path d="M6 6h12M6 12h12M6 18h12"/></svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 id="dc-title-label" class="font-bold text-purple-400 text-[11px] uppercase tracking-tighter">Data Center</h4>
                                    <p class="text-[10px] text-gray-400"><span id="dc-demand-label">200</span> MW | $<span id="dc-revenue-label">2.5k</span>/s</p>
                                </div>
                                <span class="text-[11px] font-bold">$<span id="cost-datacenter">1.5M</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500" id="datacenter-desc"><span id="count-datacenter">0</span> Units</p>
                        </div>
                    </div>

                    <div id="btn-skyscraper" onclick="buyBuilding('skyscraper')" class="building-card p-3 rounded-md cursor-pointer disabled-milestone flex items-center gap-4 transition-all">
                        <div class="icon-container text-cyan-400"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V3l14 0v18M9 7h1M9 11h1M9 15h1M14 7h1M14 11h1M14 15h1"/></svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-cyan-400 text-[11px] uppercase tracking-tighter">Commercial Hub</h4>
                                <span class="text-[11px] font-bold">$<span id="cost-skyscraper">50M</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500" id="skyscraper-desc">1k MW | $25k/s ‚Ä¢ <span id="count-skyscraper">0</span> Units</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900/50 p-4 border border-gray-800 rounded-md">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">üõ°Ô∏è PERSONNEL</h4>
                        <span class="text-[10px] font-bold text-gray-600"><span id="manager-count">0</span>/4</span>
                    </div>
                    <div id="manager-slots" class="grid grid-cols-2 gap-2"></div>
                </div>

                <div class="bg-gray-900/50 p-4 border border-gray-800 rounded-md">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">District Monitor</h4>
                        <button onclick="buyLand()" id="btn-buy-land" class="text-[9px] bg-blue-900/20 border border-blue-800 px-2 py-0.5 rounded text-blue-400 hover:bg-blue-800/40 transition-all font-bold">EXPAND (+100 Slots) $<span id="land-cost">10k</span></button>
                    </div>
                    <div id="city-visual-grid" class="flex flex-wrap gap-1 max-h-[160px] overflow-y-auto pr-1"></div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="lg:col-span-8 space-y-6">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                    <h3 class="text-lg font-bold flex items-center uppercase tracking-tighter">
                        <span class="mr-2 text-xl">‚ò¢Ô∏è</span> Reactor Command
                    </h3>
                    <button id="master-ovr-btn" class="hidden master-ovr-btn px-4 py-1 text-[9px] font-bold border border-gray-600 bg-gray-800 text-gray-400 rounded hover:border-red-500 transition-all uppercase tracking-widest">
                        HOLD MASTER OVR
                    </button>
                </div>

                <div id="reactor-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Dynamic Units and Buy card appear here -->
                </div>

                <!-- UPGRADE TRAY -->
                <div id="upgrade-tray-container" class="bg-gray-900/40 border border-gray-800 p-4 rounded-lg mt-8 shadow-inner">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center">
                        <span class="mr-2 text-blue-500">‚öôÔ∏è</span> STRATEGIC UPGRADES & MODIFIERS
                    </h4>
                    <div id="upgrade-tray" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Upgrades sorted: Available -> Expensive -> Installed -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- DEBUG CONSOLE -->
    <div id="debug-panel">
        <div class="max-w-6xl mx-auto flex gap-4 items-center flex-wrap">
            <span class="text-red-500 font-bold uppercase">Superintendent Access:</span>
            <button onclick="state.cash += 100000000; refreshStaticUI();" class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">+$100M Cash</button>
            <button onclick="debugInstantResearch()" class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">Max Research</button>
            <button onclick="state.reactors.forEach(r => r.heat = 0)" class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">Reset Heat</button>
            <button id="btn-ff" onclick="debugToggleFF()" class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">FF Toggle (OFF)</button>
            <button onclick="toggleDebug()" class="bg-red-900/40 px-2 py-1 rounded border border-red-500 text-red-500 ml-auto">CLOSE CONSOLE</button>
        </div>
    </div>
    <button onclick="toggleDebug()" class="fixed bottom-4 right-4 z-[99] bg-red-900/20 border border-red-900 text-red-900 hover:text-red-500 hover:border-red-500 text-[8px] px-2 py-1 rounded uppercase tracking-widest">Debug Access</button>

    <template id="reactor-template">
        <div class="reactor-unit p-4 bg-gray-900/80 border border-gray-700 rounded-lg relative overflow-hidden transition-all reactor-card-fixed">
            <div class="flex justify-between mb-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-tighter">UNIT <span class="u-id">X</span></span>
                <span class="u-gen text-[9px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 font-bold uppercase tracking-widest">GEN II</span>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-[10px] font-bold mb-1">
                    <span>CORE TEMP: <span class="u-temp-val">0%</span></span>
                    <span class="text-emerald-400 tracking-tighter">STACKED MULT: <span class="u-multiplier-val">1.0x</span></span>
                </div>
                <div class="heat-bar-bg rounded-sm">
                    <div class="heat-zone-marker" style="left: 25%;"></div>
                    <div class="heat-zone-marker" style="left: 50%;"></div>
                    <div class="heat-zone-marker" style="left: 75%;"></div>
                    <div class="heat-bar-fill w-0 zone-tier-1 u-heat-fill"></div>
                </div>
            </div>
            <div class="text-center space-y-3">
                <div class="flex justify-between text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">
                    <span>Output: <span class="u-power">0</span> MW</span>
                    <span class="text-blue-400">Share: $<span class="u-rev">0</span>/s</span>
                </div>
                <button class="u-overdrive-btn w-full py-4 bg-gray-800 border border-gray-600 text-[10px] font-bold tracking-tighter hover:bg-gray-700 active:bg-red-950 transition-colors uppercase">Hold to Overdrive</button>
                <button class="u-upgrade-btn w-full py-1 text-[9px] text-emerald-500 border border-emerald-900/50 rounded-sm hover:bg-emerald-900/30 transition-all uppercase disabled:opacity-30">Retrofit Core ($<span class="u-upgrade-cost">5k</span>)</button>
            </div>
            <div class="u-scram-overlay hidden absolute inset-0 bg-red-950/60 flex flex-col items-center justify-center backdrop-blur-[2px] z-20 text-center">
                <span class="text-white font-bold text-xl tracking-tighter uppercase">Scram Active</span>
                <span class="text-[10px] text-red-200 mt-2 font-bold uppercase text-shadow-sm">Cooling Core...</span>
            </div>
        </div>
    </template>

    <template id="buy-unit-template">
        <div id="add-unit-card" onclick="addReactor()" class="p-4 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 group transition-all reactor-card-fixed">
            <span class="text-4xl text-gray-600 group-hover:text-emerald-500">+</span>
            <span class="text-xs text-gray-500 mt-2 font-bold uppercase tracking-widest">Commission Unit</span>
            <span class="text-[10px] text-emerald-600 font-bold" id="unit-cost-label-dynamic">$5,000</span>
        </div>
    </template>

    <script>
        const INITIAL_STATE = {
            cash: 150,
            managers: [],
            buildings: {
                house: { count: 0, baseCost: 100, demand: 1, revenue: 2 },
                factory: { count: 0, baseCost: 15000, demand: 25, revenue: 150 },
                datacenter: { count: 0, baseCost: 2000000, demand: 200, revenue: 2500 },
                skyscraper: { count: 0, baseCost: 50000000, demand: 1000, revenue: 25000 }
            },
            reactors: [{ id: 1, gen: 2, heat: 0, isOverdrive: false, isScrammed: false, upgradeCost: 5000, baseMW: 30 }],
            nextUnitCost: 5000,
            managerCost: 1000,
            hasSync: false,
            hasFirefighters: false,
            hasSmartGrid: false,
            hasAI: false,
            hasLLM: false,
            maxGenUnlocked: 2,
            masterOverdriveActive: false,
            ffMultiplier: 1,
            lastTickCash: 0,
            debugOpen: false,
            districtSize: 100,
            landCost: 10000
        };

        const UPGRADES = [
            {
                id: 'arch',
                name: 'R&D Laboratory',
                getLabel: (s) => s.maxGenUnlocked < 4 ? ("Develop advanced core blueprints for GEN " + (s.maxGenUnlocked + 1) + " units. Massive increase to Power Capacity and base Revenue yield.") : (s.maxGenUnlocked === 4 ? "Research FUSION Architecture (GEN V). Capable of sustaining 1.5GW base load per core." : "Fusion Era Unlocked"),
                getCost: (s) => (s.maxGenUnlocked === 2 ? 250000 : (s.maxGenUnlocked === 3 ? 1250000 : 100000000)),
                isInstalled: (s) => s.maxGenUnlocked >= 5,
                canBuy: () => true,
                action: buyArchitecture
            },
            {
                id: 'sync',
                name: 'Synchronous Overdrive',
                getLabel: () => 'Unlocks Master Overdrive button which allows for control of all reactor units simultaneously.',
                getCost: () => 50000,
                isInstalled: (s) => s.hasSync,
                canBuy: () => true,
                action: () => { state.hasSync = true; }
            },
            {
                id: 'fire',
                name: 'Firefighters',
                getLabel: () => 'On site emergency services reduce SCRAM time by 20%, bringing crashed units back online significantly faster.',
                getCost: () => 75000,
                isInstalled: (s) => s.hasFirefighters,
                canBuy: () => true,
                action: () => { state.hasFirefighters = true; }
            },
            {
                id: 'grid',
                name: 'Smart Grid',
                getLabel: () => 'Install automated load-shedding hardware. Prevents city revenue from crashing during brownouts, maintaining a 90% income floor.',
                getCost: () => 500000,
                isInstalled: (s) => s.hasSmartGrid,
                canBuy: () => true,
                action: () => { state.hasSmartGrid = true; }
            },
            {
                id: 'ai',
                name: 'Artificial Intelligence',
                getLabel: () => 'Integrate neural networks. Data Centers produce 2x profit but use 3x more energy (600MW).',
                getCost: () => 1500000,
                isInstalled: (s) => s.hasAI,
                canBuy: () => true,
                action: () => { state.hasAI = true; }
            },
            {
                id: 'llm',
                name: 'Large Language Models (LLM)',
                getLabel: () => 'Efficiencies in AI usage reduces data center energy use to 2x (400MW). REQUIRES Artificial Intelligence.',
                getCost: () => 5000000,
                isInstalled: (s) => s.hasLLM,
                canBuy: (s) => s.hasAI,
                action: () => { state.hasLLM = true; }
            }
        ];

        const MANAGER_TYPES = {
            engineer: { name: "Engineer", bonus: "+15% Power", color: "emerald", desc: "Optimizes turbines to increase total MegaWatt capacity." },
            procurement: { name: "Procurement", bonus: "-10% Price", color: "blue", desc: "Negotiates bulk rates to reduce city construction costs." },
            safety: { name: "Safety", bonus: "-20% Heat", color: "red", desc: "Advanced liquid cooling slows core temperature rise." },
            tax: { name: "Tax Consultant", bonus: "+15% Revenue", color: "purple", desc: "Maximizes taxation revenue from all buildings on the grid." }
        };

        const GEN_STABILITY = { 2: 1.0, 3: 0.75, 4: 0.5, 5: 0.4 };
        const GEN_TIER_MULTIPLIERS = {
            2: [1.10, 1.30, 1.70, 2.00],
            3: [1.30, 1.60, 2.20, 2.80],
            4: [1.50, 2.00, 3.00, 4.00],
            5: [1.80, 2.50, 4.00, 6.00]
        };
        const GEN_BASE_GRANT = { 2: 5, 3: 50, 4: 250, 5: 2500 };

        let state = JSON.parse(JSON.stringify(INITIAL_STATE));
        let lastTick = Date.now();

        function getHeatFillClass(heat) {
            if (heat >= 75) return 'zone-tier-4';
            if (heat >= 50) return 'zone-tier-3';
            if (heat >= 25) return 'zone-tier-2';
            if (heat >= 1) return 'zone-tier-1';
            return 'bg-gray-700';
        }

        function toggleDebug() {
            state.debugOpen = !state.debugOpen;
            const panel = document.getElementById('debug-panel');
            if (panel) panel.style.display = (state.debugOpen ? 'block' : 'none');
        }

        function debugInstantResearch() {
            state.maxGenUnlocked = 5; state.hasSync = true; state.hasFirefighters = true; state.hasSmartGrid = true; state.hasAI = true; state.hasLLM = true; refreshStaticUI(); renderReactors();
        }

        function debugToggleFF() {
            state.ffMultiplier = (state.ffMultiplier === 1 ? 5 : 1);
            const ffBtn = document.getElementById('btn-ff');
            if (ffBtn) ffBtn.innerText = "FF Toggle (" + state.ffMultiplier + "x)";
        }

        function buyLand() {
            if (state.cash >= state.landCost) {
                state.cash -= state.landCost;
                state.districtSize += 100;
                state.landCost *= 5;
                refreshStaticUI();
            }
        }

        function refreshStaticUI() {
            const pC = state.managers.filter(m => m.type === 'procurement').length;
            const discount = 1 - (pC * 0.10);

            ['house', 'factory', 'datacenter', 'skyscraper'].forEach(t => {
                const b = state.buildings[t];
                const countEl = document.getElementById('count-' + t);
                const costEl = document.getElementById('cost-' + t);
                if (countEl) countEl.innerText = b.count;
                if (costEl) costEl.innerText = formatNum(Math.floor(b.baseCost * Math.pow(1.2, b.count) * discount));
            });

            const dcTitle = document.getElementById('dc-title-label');
            if (dcTitle) dcTitle.innerText = (state.hasAI ? "AI DATA CENTER" : "DATA CENTER");
            const dcDemand = state.hasLLM ? 400 : (state.hasAI ? 600 : 200);
            const dcRevenue = state.hasAI ? 5000 : 2500;
            const demandLabel = document.getElementById('dc-demand-label');
            const revLabel = document.getElementById('dc-revenue-label');
            if (demandLabel) demandLabel.innerText = dcDemand;
            if (revLabel) revLabel.innerText = formatNum(dcRevenue);

            const hC = state.buildings.house.count, fC = state.buildings.factory.count, dC = state.buildings.datacenter.count;
            const fusUnlocked = state.maxGenUnlocked >= 5;

            const btnFactory = document.getElementById('btn-factory');
            if (btnFactory) btnFactory.classList.toggle('disabled-milestone', hC < 10);

            const btnDC = document.getElementById('btn-datacenter');
            if (btnDC) btnDC.classList.toggle('disabled-milestone', fC < 20);

            const btnSky = document.getElementById('btn-skyscraper');
            const skyIsLocked = dC < 10 || !fusUnlocked;
            if (btnSky) btnSky.classList.toggle('disabled-milestone', skyIsLocked);

            const skyDescEl = document.getElementById('skyscraper-desc');
            if (skyDescEl) {
                let skyDesc = "1k MW | $25k/s ‚Ä¢ " + state.buildings.skyscraper.count + " Units";
                if (dC < 10) skyDesc = "Unlock: 10 Data Centers";
                else if (!fusUnlocked) skyDesc = "Unlock: Research FUSION";
                skyDescEl.innerText = skyDesc;
            }

            const landCostEl = document.getElementById('land-cost');
            if (landCostEl) landCostEl.innerText = formatNum(state.landCost);

            const mBtn = document.getElementById('master-ovr-btn');
            if (state.hasSync && mBtn) { mBtn.classList.remove('hidden'); setupMasterHoldEvents(); }

            renderUpgradeTray();
            const dClabel = document.getElementById('unit-cost-label-dynamic');
            if (dClabel) dClabel.innerText = '$' + formatNum(state.nextUnitCost);
        }

        function renderUpgradeTray() {
            const tray = document.getElementById('upgrade-tray');
            if (!tray) return;

            let sorted = [...UPGRADES];
            sorted.sort((a, b) => {
                const installedA = a.isInstalled(state);
                const installedB = b.isInstalled(state);
                if (installedA !== installedB) return (installedA ? 1 : -1);
                const canBuyA = (a.canBuy(state) && state.cash >= a.getCost(state));
                const canBuyB = (b.canBuy(state) && state.cash >= b.getCost(state));
                if (canBuyA !== canBuyB) return (canBuyA ? -1 : 1);
                return (a.getCost(state) - b.getCost(state));
            });

            tray.innerHTML = '';
            sorted.forEach(u => {
                const isInstalled = u.isInstalled(state);
                const cost = u.getCost(state);
                const isAffordable = (state.cash >= cost);
                const canBuy = u.canBuy(state);

                const el = document.createElement('div');
                let statusClass = isInstalled ? 'installed' : ((isAffordable && canBuy) ? 'affordable' : 'locked');
                el.className = "upgrade-tray-item " + statusClass;
                el.dataset.id = u.id;

                if (!isInstalled) {
                    el.onclick = () => { if (state.cash >= cost && canBuy) { state.cash -= cost; u.action(); refreshStaticUI(); } };
                }

                const costFormatted = formatNum(cost);
                const nameDisplay = u.name + (isInstalled ? "" : " ($" + costFormatted + ")");
                const badgeHtml = isInstalled ? '<span class="installed-badge">System Active</span>' : '';
                const costStyle = (isAffordable && canBuy ? 'text-emerald-400' : 'text-rose-500');
                const costHtml = isInstalled ? "" : '<div class="upgrade-cost-text ' + costStyle + '">$' + costFormatted + '</div>';

                el.innerHTML = `
                    ${badgeHtml}
                    <div class="upgrade-title-text ${isInstalled ? 'text-blue-300' : 'text-gray-100'} uppercase">
                        ${nameDisplay}
                    </div>
                    <div class="upgrade-desc-text ${isInstalled ? 'text-blue-500' : 'text-gray-400'}">${u.getLabel(state)}</div>
                    ${costHtml}
                `;
                tray.appendChild(el);
            });
        }

        function setupMasterHoldEvents() {
            const btn = document.getElementById('master-ovr-btn');
            if (!btn || btn.dataset.setup) return;
            const startM = (e) => { e.preventDefault(); state.masterOverdriveActive = true; btn.classList.add('master-ovr-active'); btn.innerText = "LINKED REDLINE ACTIVE"; };
            const stopM = () => { state.masterOverdriveActive = false; btn.classList.remove('master-ovr-active'); btn.innerText = "Hold for Master Overdrive"; state.reactors.forEach(r => r.isOverdrive = false); };
            btn.onmousedown = startM; btn.onmouseup = stopM; btn.onmouseleave = stopM; btn.ontouchstart = startM; btn.ontouchend = stopM;
            btn.dataset.setup = "true";
        }

        function buyBuilding(type) {
            const b = state.buildings[type];
            const pC = state.managers.filter(m => m.type === 'procurement').length;
            const disc = 1 - (pC * 0.10);
            const cost = Math.floor(b.baseCost * Math.pow(1.2, b.count) * disc);
            if ((type === 'factory' && state.buildings.house.count < 10) ||
                (type === 'datacenter' && state.buildings.factory.count < 20) ||
                (type === 'skyscraper' && (state.buildings.datacenter.count < 10 || state.maxGenUnlocked < 5))) return;
            if (state.cash >= cost) { state.cash -= cost; b.count++; refreshStaticUI(); }
        }

        function hireManager() {
            if (state.managers.length >= 4 || state.cash < state.managerCost) return;
            state.cash -= state.managerCost;
            state.managers.push({ id: Date.now(), type: 'engineer' });
            state.managerCost = Math.floor(state.managerCost * 32);
            renderManagers(); refreshStaticUI();
        }

        function buyArchitecture() { if (state.maxGenUnlocked < 5) { state.maxGenUnlocked++; renderReactors(); refreshStaticUI(); } }

        function updateManagerType(managerId, nT) {
            const m = state.managers.find(m => m.id === managerId);
            if (m) {
                m.type = nT;
                const idx = state.managers.indexOf(m);
                const bEl = document.getElementById('manager-bonus-' + idx);
                const tEl = document.getElementById('manager-tooltip-' + idx);
                if (bEl) bEl.innerText = MANAGER_TYPES[nT].bonus;
                if (tEl) tEl.innerText = MANAGER_TYPES[nT].desc;
                refreshStaticUI();
            }
        }

        function renderManagers() {
            const container = document.getElementById('manager-slots');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const m = state.managers[i];
                const slot = document.createElement('div');
                slot.className = "border border-gray-700 bg-gray-900/80 rounded p-2 flex flex-col justify-between h-20 transition-all";
                if (m) {
                    const ct = MANAGER_TYPES[m.type];
                    slot.innerHTML = `
                        <div class="flex justify-between items-start">
                            <span class="text-[7px] font-bold text-gray-600 uppercase flex items-center">P-${i+1} <div class="tooltip ml-1 cursor-help"><span class="text-[10px] text-gray-400 bg-gray-800 px-1 rounded-full border border-gray-700">?</span><span class="tooltiptext" id="manager-tooltip-${i}">${ct.desc}</span></div></span>
                            <span class="text-[7px] font-bold text-emerald-500 uppercase animate-pulse">Online</span>
                        </div>
                        <div class="my-1"><select class="manager-select" onchange="updateManagerType(${m.id}, this.value)">${Object.keys(MANAGER_TYPES).map(t => `<option value="${t}" ${t === m.type ? 'selected' : ''}>${MANAGER_TYPES[t].name}</option>`).join('')}</select></div>
                        <div id="manager-bonus-${i}" class="text-[6px] text-gray-500 leading-tight uppercase font-bold tracking-tighter">${ct.bonus}</div>
                    `;
                } else {
                    slot.innerHTML = `<button onclick="hireManager()" id="hire-btn-${i}" class="w-full h-full flex flex-col items-center justify-center group transition-all"><span class="text-[9px] font-bold text-emerald-500 group-hover:text-emerald-400 uppercase">+ Hire</span><span class="text-[7px] text-gray-500 font-bold">$${formatNum(state.managerCost)}</span></button>`;
                    if (state.managers.length >= 4) slot.innerHTML = `<div class="w-full h-full flex items-center justify-center"><span class="text-[8px] text-gray-800 font-bold uppercase tracking-widest">Reserved</span></div>`;
                }
                container.appendChild(slot);
            }
            const managerCountEl = document.getElementById('manager-count');
            if (managerCountEl) managerCountEl.innerText = state.managers.length;
        }

        function addReactor() {
            if (state.reactors.length < 4 && state.cash >= state.nextUnitCost) {
                state.cash -= state.nextUnitCost;
                state.reactors.push({ id: state.reactors.length+1, gen: 2, heat: 0, isOverdrive: false, isScrammed: false, upgradeCost: 15000*(state.reactors.length+1), baseMW: 30 });
                state.nextUnitCost *= 10;
                renderReactors(); refreshStaticUI();
            }
        }

        function upgradeReactor(id) {
            const r = state.reactors.find(x => x.id === id);
            if (r && r.gen < state.maxGenUnlocked && state.cash >= r.upgradeCost) {
                state.cash -= r.upgradeCost;
                r.gen++;
                if (r.gen === 5) {
                    r.baseMW = 1500;
                } else {
                    r.baseMW *= 3.5;
                }
                r.upgradeCost *= 10;
                renderReactors(); refreshStaticUI();
            }
        }

        function renderReactors() {
            const grid = document.getElementById('reactor-grid');
            if (!grid) return;
            grid.innerHTML = '';
            state.reactors.forEach(r => {
                const clone = document.getElementById('reactor-template').content.cloneNode(true);
                const root = clone.querySelector('.reactor-unit');
                root.dataset.id = r.id;
                root.querySelector('.u-id').innerText = r.id;

                let genLabel = "GEN " + (r.gen === 2 ? "II" : r.gen === 3 ? "III" : r.gen === 4 ? "IV" : "V");
                if (r.gen === 5) {
                    genLabel = "FUSION";
                    root.querySelector('.u-gen').classList.add('text-cyan-400', 'border-cyan-900');
                }
                root.querySelector('.u-gen').innerText = genLabel;
                root.querySelector('.u-upgrade-cost').innerText = formatNum(r.upgradeCost);

                const upBtn = root.querySelector('.u-upgrade-btn');
                if (r.gen >= state.maxGenUnlocked) {
                    upBtn.innerText = (r.gen === 5 ? "STABLE EQUILIBRIUM" : "RESEARCH REQ.");
                    upBtn.disabled = true;
                }
                else upBtn.onclick = () => upgradeReactor(r.id);

                const ovrBtn = root.querySelector('.u-overdrive-btn');
                const startO = (e) => { e.preventDefault(); if (!state.masterOverdriveActive) r.isOverdrive = true; };
                const stopO = () => { if (!state.masterOverdriveActive) r.isOverdrive = false; };
                ovrBtn.onmousedown = startO; ovrBtn.onmouseup = stopO; ovrBtn.onmouseleave = stopO; ovrBtn.ontouchstart = startO; ovrBtn.ontouchend = stopO;
                grid.appendChild(clone);
            });
            if (state.reactors.length < 4) { grid.appendChild(document.getElementById('buy-unit-template').content.cloneNode(true)); }
        }

        function formatNum(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return Math.floor(num);
        }

        function gameLoop() {
            const now = Date.now();
            const dt = ((now - lastTick) / 1000) * state.ffMultiplier;
            lastTick = now;

            let powerAvail = 0, unitRevTotal = 0;
            const eC = state.managers.filter(m => m.type === 'engineer').length, sC = state.managers.filter(m => m.type === 'safety').length, tC = state.managers.filter(m => m.type === 'tax').length;
            const pM = 1 + (eC * 0.15), hM = 1 - (sC * 0.20), rM = 1 + (tC * 0.15);

            if (state.masterOverdriveActive) state.reactors.forEach(r => { if (!r.isScrammed) r.isOverdrive = true; });

            let cascade = false;
            state.reactors.forEach(r => {
                const ui = document.querySelector('.reactor-unit[data-id="' + r.id + '"]');
                if (!ui) return;
                const stab = GEN_STABILITY[r.gen] || 1.0;
                if (r.isScrammed) {
                    const rR = state.hasFirefighters ? 15 : 12;
                    r.heat -= dt * rR; if (r.heat <= 0) { r.heat = 0; r.isScrammed = false; }
                    ui.classList.add('scram-active');
                } else {
                    ui.classList.remove('scram-active');
                    if (r.isOverdrive) {
                        r.heat += dt * 16 * (1 + (r.heat / 40)) * hM * stab;
                        if (r.heat >= 100) { r.heat = 100; r.isScrammed = true; r.isOverdrive = false; if (state.masterOverdriveActive) cascade = true; }
                    } else r.heat = Math.max(0, r.heat - dt * 5);
                    ui.classList.toggle('shake-light', r.heat > 50 && r.heat <= 75); ui.classList.toggle('shake-heavy', r.heat > 75);
                }
                const m = r.isOverdrive ? 2.5 : 1, o = (r.isScrammed ? 0 : r.baseMW * m) * pM;
                powerAvail += o;
                const tierIdx = (r.heat < 25 ? 0 : r.heat < 50 ? 1 : r.heat < 75 ? 2 : 3);
                const zm = r.isScrammed ? 0 : (r.heat < 1 ? 1 : GEN_TIER_MULTIPLIERS[r.gen][tierIdx]);
                const unitRev = (GEN_BASE_GRANT[r.gen] || 5) * zm;
                unitRevTotal += unitRev;
                ui.querySelector('.u-temp-val').innerText = Math.floor(r.heat) + '%'; ui.querySelector('.u-multiplier-val').innerText = zm.toFixed(2) + 'x';
                const f = ui.querySelector('.u-heat-fill'); f.style.width = r.heat + '%';
                f.className = 'heat-bar-fill u-heat-fill ' + getHeatFillClass(r.heat);
                ui.querySelector('.u-power').innerText = Math.floor(o); ui.querySelector('.u-rev').innerText = formatNum(unitRev);
                ui.querySelector('.u-scram-overlay').classList.toggle('hidden', !r.isScrammed);
            });

            if (cascade) {
                state.masterOverdriveActive = false; const mB = document.getElementById('master-ovr-btn');
                if (mB) { mB.classList.remove('master-ovr-active'); mB.innerText = "Hold for Master Overdrive"; }
                state.reactors.forEach(r => { r.isScrammed = true; r.isOverdrive = false; r.heat = 100; });
            }

            const dcDemand = state.hasLLM ? 400 : (state.hasAI ? 600 : 200);
            const dcRevenue = state.hasAI ? 5000 : 2500;
            const demand = (state.buildings.house.count * 1) + (state.buildings.factory.count * 25) + (state.buildings.datacenter.count * dcDemand) + (state.buildings.skyscraper.count * 1000);
            const isBrownout = powerAvail < demand && demand > 0, eff = isBrownout ? (state.hasSmartGrid ? 0.90 : 0.70) : 1.00;

            let wm = 0;
            if (powerAvail > 0) state.reactors.forEach(r => { if (!r.isScrammed) {
                const s = (r.baseMW * (r.isOverdrive?2.5:1) * pM) / powerAvail;
                const tierIdx = (r.heat < 25 ? 0 : r.heat < 50 ? 1 : r.heat < 75 ? 2 : 3);
                wm += (r.heat < 1 ? 1 : GEN_TIER_MULTIPLIERS[r.gen][tierIdx]) * s;
            }});

            const cityBase = (state.buildings.house.count * 2) + (state.buildings.factory.count * 150) + (state.buildings.datacenter.count * dcRevenue) + (state.buildings.skyscraper.count * 25000);
            const surplus = Math.max(0, powerAvail - demand), exportInc = surplus * 0.5;
            const finalInc = (cityBase * eff * wm * rM) + (unitRevTotal * rM) + exportInc;
            state.cash += (finalInc * dt);

            const cashDisplay = document.getElementById('cash-display');
            const incomeDisplay = document.getElementById('income-display');
            const exportDisplay = document.getElementById('export-display');
            const powerTotal = document.getElementById('power-total');
            const powerUsed = document.getElementById('power-used');
            if (cashDisplay) cashDisplay.innerText = formatNum(state.cash);
            if (incomeDisplay) incomeDisplay.innerText = formatNum(finalInc);
            if (exportDisplay) exportDisplay.innerText = formatNum(exportInc);
            if (powerTotal) powerTotal.innerText = Math.floor(powerAvail);
            if (powerUsed) powerUsed.innerText = Math.floor(demand);

            const effTag = document.getElementById('efficiency-tag');
            if (effTag) {
                effTag.innerText = "Efficiency: " + Math.round(eff*100) + "%";
                effTag.className = "text-[9px] font-bold px-2 py-0.5 rounded-full inline-block mt-1 " + (isBrownout ? 'text-red-500 bg-red-950/30' : 'text-emerald-500 bg-emerald-950/30');
            }

            const sI = document.getElementById('stability-indicator');
            if (sI) {
                sI.innerText = (isBrownout ? "BROWNOUT DETECTED" : "Grid Stable");
                sI.className = "text-[10px] uppercase font-bold tracking-widest " + (isBrownout ? 'text-red-500 animate-pulse' : 'text-emerald-500');
            }

            if (Math.abs(state.cash - state.lastTickCash) > (state.cash * 0.05) || state.cash < 500) {
                 renderUpgradeTray();
                 state.lastTickCash = state.cash;
            }

            const trayItems = document.querySelectorAll('.upgrade-tray-item');
            trayItems.forEach(el => {
                const u = UPGRADES.find(x => x.id === el.dataset.id);
                if (u && !u.isInstalled(state)) {
                    const isAff = (state.cash >= u.getCost(state));
                    const canB = u.canBuy(state);
                    el.classList.toggle('affordable', isAff && canB);
                    el.classList.toggle('locked', !isAff || !canB);
                }
            });

            const gridDiv = document.getElementById('city-visual-grid');
            if (gridDiv) {
                const totalD = state.buildings.house.count + state.buildings.factory.count + state.buildings.datacenter.count + state.buildings.skyscraper.count;
                if (gridDiv.children.length !== Math.min(state.districtSize, totalD)) {
                    gridDiv.innerHTML = '';
                    let d = 0;
                    const types = [
                        {c: state.buildings.skyscraper.count, cl: 'bg-cyan-400 shadow-[0_0_8px_cyan]'},
                        {c: state.buildings.datacenter.count, cl: 'bg-purple-500 shadow-[0_0_5px_purple]'},
                        {c: state.buildings.factory.count, cl: 'bg-blue-500 shadow-[0_0_5px_blue]'},
                        {c: state.buildings.house.count, cl: 'bg-emerald-500 shadow-[0_0_5px_emerald]'}
                    ];
                    types.forEach(type => { for(let i=0; i<type.c && d < state.districtSize; i++) { const el = document.createElement('div'); el.className = "city-grid-item " + type.cl; gridDiv.appendChild(el); d++; } });
                }
                gridDiv.querySelectorAll('.city-grid-item').forEach(item => item.classList.toggle('city-grid-dim', isBrownout));
                gridDiv.classList.toggle('brownout-flicker', isBrownout);
            }

            const btnBuyLand = document.getElementById('btn-buy-land');
            if (btnBuyLand) btnBuyLand.classList.toggle('not-affordable', state.cash < state.landCost);

            requestAnimationFrame(gameLoop);
        }

        renderReactors(); renderManagers(); refreshStaticUI(); requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
